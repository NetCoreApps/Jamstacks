import{_ as a}from"./MarkdownPage.f8f3da68.js";import{i as l,o as i,j as c,w as r,d as e,s as n}from"./vendor.27327011.js";import"./AppBreadcrumb.4414bdb6.js";const u=e("div",{class:"markdown-body"},[e("h1",null,"ServiceStack GitHub Action Deployments"),e("p",null,[n("The "),e("a",{href:"https://github.com/NetCoreTemplates/vue-ssg/blob/main/.github/workflows/release.yml",target:"_blank",rel:"noopener"},"release.yml"),n(" in this template enables GitHub Actions CI deployment to a dedicated server with SSH access.")]),e("h2",null,"Overview"),e("p",null,[e("code",null,"release.yml"),n(" is designed to work with a ServiceStack app deploying directly to a single server via SSH. A docker image is built and stored on GitHub\u2019s "),e("code",null,"ghcr.io"),n(" docker registry when a GitHub Release is created.")]),e("p",null,[n("GitHub Actions specified in "),e("code",null,"release.yml"),n(" then copy files remotely via scp and use "),e("code",null,"docker-compose"),n(" to run the app remotely via SSH.")]),e("h2",null,[n("What\u2019s the process of "),e("code",null,"release.yml"),n("?")]),e("p",null,[e("img",{src:"https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/mix/release-ghr-vanilla-diagram.png",alt:""})]),e("h2",null,"Deployment server setup"),e("p",null,"To get this working, a server needs to be setup with the following:"),e("ul",null,[e("li",null,"SSH access"),e("li",null,"docker"),e("li",null,"docker-compose"),e("li",null,"ports 443 and 80 for web access of your hosted application")]),e("p",null,"This can be your own server or any cloud hosted server like Digital Ocean, AWS, Azure etc."),e("p",null,[n("When setting up your server, you\u2019ll want to use a dedicated SSH key for access to be used by GitHub Actions. GitHub Actions will need the "),e("em",null,"private"),n(" SSH key within a GitHub Secret to authenticate. This can be done via ssh-keygen and copying the public key to the authorized clients on the server.")]),e("p",null,[n("To let your server handle multiple ServiceStack applications and automate the generation and management of TLS certificates, an additional docker-compose file is provided in this template, "),e("code",null,"nginx-proxy-compose.yml"),n(". This docker-compose file is ready to run and can be copied to the deployment server.")]),e("p",null,[n("For example, once copied to remote "),e("code",null,"~/nginx-proxy-compose.yml"),n(", the following command can be run on the remote server.")]),e("pre",{class:"language-bash"},[e("code",{class:"language-bash"},`docker-compose -f ~/nginx-proxy-compose.yml up -d
`)]),e("p",null,"This will run an nginx reverse proxy along with a companion container that will watch for additional containers in the same docker network and attempt to initialize them with valid TLS certificates."),e("h2",null,"GitHub Repository setup"),e("p",null,[n("This template pushes the API server dockerized application to GitHub Container Repository. To do this, you will first need to "),e("a",{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",target:"_blank",rel:"noopener"},"create a Personal Access Token"),n(" specifically for use by "),e("code",null,"release.yml"),n(" GitHub Actions.")]),e("p",null,[n("This token will need to have access to "),e("code",null,"write:packages"),n(" to the GitHub Package Registry, which includes the GitHub Container Registry.")]),e("p",null,[n("The first time the "),e("code",null,"release.yml"),n(" process successfully runs and creates your GitHub Container Repository for your project, you then have the option to "),e("a",{href:"https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions#upgrading-a-workflow-that-accesses-ghcrio",target:"_blank",rel:"noopener"},"upgrade the workflow to use GITHUB_TOKEN"),n(" replacing the "),e("code",null,"CR_PAT"),n(".")]),e("h3",null,"GitHub Actions secrets"),e("p",null,[n("The "),e("code",null,"release.yml"),n(" assumes 5 secrets have been set:")]),e("table",null,[e("thead",null,[e("tr",null,[e("th",null,"Required Secrets"),e("th",null,"Description")])]),e("tbody",null,[e("tr",null,[e("td",null,[e("code",null,"CR_PAT")]),e("td",null,"GitHub Personal Token with read/write access to packages")]),e("tr",null,[e("td",null,[e("code",null,"DEPLOY_API")]),e("td",null,"Hostname used to SSH deploy .NET App to, this can either be an IP address or subdomain with A record pointing to the server")]),e("tr",null,[e("td",null,[e("code",null,"DEPLOY_USERNAME")]),e("td",null,[n("Username to log in with via SSH e.g, "),e("strong",null,"ubuntu"),n(", "),e("strong",null,"ec2-user"),n(", "),e("strong",null,"root")])]),e("tr",null,[e("td",null,[e("code",null,"DEPLOY_KEY")]),e("td",null,"SSH private key used to remotely access deploy .NET App")]),e("tr",null,[e("td",null,[e("code",null,"LETSENCRYPT_EMAIL")]),e("td",null,"Email required for Let\u2019s Encrypt automated TLS certificates")])])]),e("p",null,"To also enable deploying static assets to a CDN:"),e("table",null,[e("thead",null,[e("tr",null,[e("th",null,"Optional Secrets"),e("th",null,"Description")])]),e("tbody",null,[e("tr",null,[e("td",null,[e("code",null,"DEPLOY_CDN")]),e("td",null,[n("Hostname where static "),e("strong",null,"/wwwroot"),n(" assets should be deployed to")])])])]),e("p",null,[n("These secrets can use the "),e("a",{href:"https://cli.github.com/manual/gh_secret_set",target:"_blank",rel:"noopener"},"GitHub CLI"),n(" for ease of creation. Eg, using the GitHub CLI the following can be set.")]),e("pre",{class:"language-bash"},[e("code",{class:"language-bash"},[n("gh secret "),e("span",{class:"token builtin class-name"},"set"),n(" CR_PAT -b"),e("span",{class:"token string"},'"<CR_PAT>"'),n(`
gh secret `),e("span",{class:"token builtin class-name"},"set"),n(" DEPLOY_API -b"),e("span",{class:"token string"},'"<DEPLOY_API>"'),n(`
gh secret `),e("span",{class:"token builtin class-name"},"set"),n(" DEPLOY_USERNAME -b"),e("span",{class:"token string"},'"<DEPLOY_USERNAME>"'),n(`
gh secret `),e("span",{class:"token builtin class-name"},"set"),n(" DEPLOY_KEY "),e("span",{class:"token operator"},"<"),n(" key.pem "),e("span",{class:"token comment"},"# DEPLOY_KEY"),n(`
gh secret `),e("span",{class:"token builtin class-name"},"set"),n(" LETSENCRYPT_EMAIL -b"),e("span",{class:"token string"},'"<LETSENCRYPT_EMAIL>"'),n(`
gh secret `),e("span",{class:"token builtin class-name"},"set"),n(" DEPLOY_CDN -b"),e("span",{class:"token string"},'"<DEPLOY_CDN>"'),n(`
`)])]),e("p",null,"These secrets are used to populate variables within GitHub Actions and other configuration files."),e("h2",null,"UI Deployment"),e("p",null,[n("The "),e("code",null,"ui"),n(" application is built and deployed to GitHub Pages during the "),e("code",null,"release.yml"),n(" workflow process by committing the result of "),e("code",null,"npm run build"),n(" to "),e("code",null,"gh-pages"),n(" branch in the repository.")]),e("p",null,[n("Variable replacement of "),e("code",null,"$DEPLOY_API"),n(" and "),e("code",null,"$DEPLOY_CDN"),n(" is performed on the following files as a way to coordinate configuration between the "),e("code",null,"ui"),n(" and "),e("code",null,"api"),n(" project.")]),e("ul",null,[e("li",null,[e("code",null,"ui/vite.config.ts"),n(" - Set backend .NET API URL for Vite Apps to use")]),e("li",null,[e("code",null,"ui/next.config.js"),n(" - Set backend .NET API URL for Next.js Apps to use")]),e("li",null,[e("code",null,"ui/post.build.js"),n(" - If exists, run from GitHub Action after "),e("code",null,"npm run build")])]),e("h3",null,"post.build.js"),e("p",null,[n("The "),e("code",null,"post.build.js"),n(" script helps when also publishing "),e("code",null,"/ui"),n(" assets to CDN by first copying the generated "),e("code",null,"index.html"),n(" home page into "),e("code",null,"404.html"),n(" in order to enable full page reloads to use SPA client routing:")]),e("pre",{class:"language-js"},[e("code",{class:"language-js"},[e("span",{class:"token keyword"},"const"),n(" fs "),e("span",{class:"token operator"},"="),n(),e("span",{class:"token function"},"require"),e("span",{class:"token punctuation"},"("),e("span",{class:"token string"},'"fs"'),e("span",{class:"token punctuation"},")"),n(`
`),e("span",{class:"token keyword"},"const"),n(" path "),e("span",{class:"token operator"},"="),n(),e("span",{class:"token function"},"require"),e("span",{class:"token punctuation"},"("),e("span",{class:"token string"},'"path"'),e("span",{class:"token punctuation"},")"),n(`

`),e("span",{class:"token comment"},"// Replaced in release.yml with GitHub Actions secrets"),n(`
`),e("span",{class:"token keyword"},"const"),n(),e("span",{class:"token constant"},"DEPLOY_API"),n(),e("span",{class:"token operator"},"="),n(),e("span",{class:"token string"},"'https://$DEPLOY_API'"),n(`
`),e("span",{class:"token keyword"},"const"),n(),e("span",{class:"token constant"},"DEPLOY_CDN"),n(),e("span",{class:"token operator"},"="),n(),e("span",{class:"token string"},"'https://$DEPLOY_CDN'"),n(`

`),e("span",{class:"token keyword"},"const"),n(),e("span",{class:"token constant"},"DIST"),n(),e("span",{class:"token operator"},"="),n(),e("span",{class:"token string"},"'../api/Jamstacks/wwwroot'"),n(`

`),e("span",{class:"token comment"},"// 404.html SPA fallback (supported by GitHub Pages, Cloudflare & Netlify CDNs)"),n(`
fs`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"copyFileSync"),e("span",{class:"token punctuation"},"("),n(`
    path`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"resolve"),e("span",{class:"token punctuation"},"("),e("span",{class:"token template-string"},[e("span",{class:"token template-punctuation string"},"`"),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"${"),e("span",{class:"token constant"},"DIST"),e("span",{class:"token interpolation-punctuation punctuation"},"}")]),e("span",{class:"token string"},"/index.html"),e("span",{class:"token template-punctuation string"},"`")]),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},","),n(`
    path`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"resolve"),e("span",{class:"token punctuation"},"("),e("span",{class:"token template-string"},[e("span",{class:"token template-punctuation string"},"`"),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"${"),e("span",{class:"token constant"},"DIST"),e("span",{class:"token interpolation-punctuation punctuation"},"}")]),e("span",{class:"token string"},"/404.html"),e("span",{class:"token template-punctuation string"},"`")]),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},")"),n(`

`),e("span",{class:"token comment"},"// Define Virtual Host for GitHub Pages CDN"),n(`
fs`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"writeFileSync"),e("span",{class:"token punctuation"},"("),e("span",{class:"token template-string"},[e("span",{class:"token template-punctuation string"},"`"),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"${"),e("span",{class:"token constant"},"DIST"),e("span",{class:"token interpolation-punctuation punctuation"},"}")]),e("span",{class:"token string"},"/CNAME"),e("span",{class:"token template-punctuation string"},"`")]),e("span",{class:"token punctuation"},","),n(),e("span",{class:"token constant"},"DEPLOY_CDN"),e("span",{class:"token punctuation"},")"),n(`

`),e("span",{class:"token comment"},"// Define /api proxy routes (supported by Cloudflare or Netlify CDNs)  "),n(`
fs`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"writeFileSync"),e("span",{class:"token punctuation"},"("),e("span",{class:"token template-string"},[e("span",{class:"token template-punctuation string"},"`"),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"${"),e("span",{class:"token constant"},"DIST"),e("span",{class:"token interpolation-punctuation punctuation"},"}")]),e("span",{class:"token string"},"/_redirects"),e("span",{class:"token template-punctuation string"},"`")]),e("span",{class:"token punctuation"},","),n(`
    fs`),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"readFileSync"),e("span",{class:"token punctuation"},"("),e("span",{class:"token template-string"},[e("span",{class:"token template-punctuation string"},"`"),e("span",{class:"token interpolation"},[e("span",{class:"token interpolation-punctuation punctuation"},"${"),e("span",{class:"token constant"},"DIST"),e("span",{class:"token interpolation-punctuation punctuation"},"}")]),e("span",{class:"token string"},"/_redirects"),e("span",{class:"token template-punctuation string"},"`")]),e("span",{class:"token punctuation"},","),n(),e("span",{class:"token string"},"'utf-8'"),e("span",{class:"token punctuation"},")"),n(`
        `),e("span",{class:"token punctuation"},"."),e("span",{class:"token function"},"replace"),e("span",{class:"token punctuation"},"("),e("span",{class:"token regex"},[e("span",{class:"token regex-delimiter"},"/"),e("span",{class:"token regex-source language-regex"},"{DEPLOY_API}"),e("span",{class:"token regex-delimiter"},"/"),e("span",{class:"token regex-flags"},"g")]),e("span",{class:"token punctuation"},","),n(),e("span",{class:"token constant"},"DEPLOY_API"),e("span",{class:"token punctuation"},")"),e("span",{class:"token punctuation"},")"),n(`
`)])]),e("p",null,[n("Whilst the "),e("code",null,"_redirects"),n(" file is a convention supported by many "),e("a",{href:"https://jamstack.wtf/#deployment",target:"_blank",rel:"noopener"},"popular Jamstack CDNs"),n(" that sets up a new rule that proxies "),e("code",null,"/api*"),n(" requests to where the production .NET App is deployed to in order for API requests to not need CORS:")]),e("pre",{class:"language-bash"},[e("code",{class:"language-bash"},[n("/api/*  "),e("span",{class:"token punctuation"},"{"),n("DEPLOY_API"),e("span",{class:"token punctuation"},"}"),n("/api/:splat  "),e("span",{class:"token number"},"200"),n(`
`)])]),e("p",null,[n("By default this template doesn\u2019t use the "),e("code",null,"/api"),n(" proxy route & makes CORS API requests so it can be freely hosted on GitHub pages CDN.")]),e("h2",null,"Pushing updates and rollbacks"),e("p",null,[n("By default, deployments of both the "),e("code",null,"ui"),n(" and "),e("code",null,"api"),n(" occur on commit to your main branch. A new Docker image for your ServiceStack API is produced, pushed to GHCR.io and hosted on your Linux server with Docker Compose. Your App\u2019s UI is built and pushed to the repository GitHub Pages.")]),e("p",null,"The template also will run the release process on the creation of a GitHub Release making it easier to switch to manual production releases."),e("p",null,[n("Additionally, the "),e("code",null,"release.yml"),n(" workflow can be run manually specifying a version. This enables production rollbacks based on previously tagged releases. A release must have already been created for the rollback build to work, it doesn\u2019t create a new Docker build based on previous code state, only redeploys as existing Docker image.")]),e("h2",null,"No CORS Hosting Options"),e("p",null,[n("The "),e("code",null,"CorsFeature"),n(" needs to be enabled when adopting our recommended deployment configuration of having static "),e("code",null,"/wwwroot"),n(" assets hosted from a CDN in order to make cross-domain requests to your .NET APIs.")]),e("h3",null,"Using a CDN Proxy"),e("p",null,[n("Should you want to, our recommended approach to avoid your App making CORS requests is to define an "),e("code",null,"/api"),n(" proxy route on your CDN to your "),e("code",null,"$DEPLOY_API"),n(" server.")]),e("p",null,[n("To better support this use-case, this template includes populating the "),e("code",null,"_redirects"),n(" file used by popular CDNs like "),e("a",{href:"https://developers.cloudflare.com/pages/platform/redirects",target:"_blank",rel:"noopener"},"Cloudflare proxy redirects"),n(" and "),e("a",{href:"https://docs.netlify.com/routing/redirects/rewrites-proxies/#proxy-to-another-service",target:"_blank",rel:"noopener"},"Netlify proxies"),n(" to define redirect and proxy rules. For AWS CloudFront you would need to define a "),e("a",{href:"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/RequestAndResponseBehaviorCustomOrigin.html",target:"_blank",rel:"noopener"},"Behavior for a custom origin"),n(".")]),e("h3",null,"No CDN"),e("p",null,[n("Of course the easiest solution is to not need CORS in the first place by not deploying to a CDN and serving both "),e("code",null,"/api"),n(" and UI from your .NET App. But this would forgo all the performance & UX benefits that has made "),e("a",{href:"https://jamstack.org",target:"_blank",rel:"noopener"},"Jamstack"),n(" approach so popular.")])],-1),y="Deployment with GitHub Actions",f="Configuring your GitHub repo for SSH and CDN deployments",w="2021-12-03T00:00:00.000Z",D=[{property:"og:title",content:"Deployment with GitHub Actions"}],A={setup(p,{expose:s}){const t={title:"Deployment with GitHub Actions",summary:"Configuring your GitHub repo for SSH and CDN deployments",date:"2021-12-03T00:00:00.000Z",meta:[{property:"og:title",content:"Deployment with GitHub Actions"}]};return s({frontmatter:t}),l({title:"Deployment with GitHub Actions",meta:[{property:"og:title",content:"Deployment with GitHub Actions"}]}),(h,k)=>{const o=a;return i(),c(o,{frontmatter:t},{default:r(()=>[u]),_:1})}}};export{w as date,A as default,D as meta,f as summary,y as title};
